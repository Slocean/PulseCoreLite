# PulseCore 全方位优化计划报告（维护性 / 扩展性 / 标准化 / 最佳实践 / 性能 / 功能 / 结构）

- 文档日期：2026-02-25
- 项目版本：`v1.4.4`
- 评估范围：`src/`、`src-tauri/`、构建与发布脚本、文档与工程配置
- 结论：当前项目功能可用、构建可通过，但存在“单文件过大 + 持久化分散 + 工程门禁不足 + 采样链路高开销”四类核心瓶颈，建议按 P0/P1/P2 分阶段治理。

## 1) 当前现状基线（作为后续验收对照）

### 1.1 构建与产物
- 前端构建：`npm run build` 可通过。
- 后端检查：`cargo check` 可通过。
- `dist/` 产物总量约 `4.43 MB`（109 个文件），其中体积最大文件集中于图标字体资源。
- 主要大文件（已观察）：
  - `material-symbols-outlined-*.woff/woff2` 单文件约 `312 KB ~ 432 KB`
  - `index-*.js` 约 `253.8 KB`

### 1.2 代码结构基线
- 超大文件：
  - `src/pages/index.vue`：约 `1393` 行
  - `src/stores/app.ts`：约 `639` 行
- 备份文件仍在主仓：`*.bak.*`（如 `src/pages/index.bak.vue`、`src/style.bak.css`）。
- 当前无测试目录（未发现 `test/spec` 文件）。
- 工程标准化文件缺失：未发现 ESLint/Prettier/CI 工作流配置。

### 1.3 技术风险基线
- GPU 采样通过外部 PowerShell 进程执行：`src-tauri/src/core/collectors/system_collector.rs:493`。
- 关机计划会执行全局 `shutdown /a`：`src-tauri/src/ipc/commands.rs:541`，可能影响非本应用创建的关机任务。
- 持久化方案并存（`localStorage` + IndexedDB KV），键分散。
- 代码中存在较多宽泛异常吞并（`catch {}`）与 `any` 类型用法。

---

## 2) 优化总目标（6 个维度）

1. **维护性**：核心页面/Store 单文件不超过 500 行，业务职责可独立演进。
2. **扩展性**：新增指标/新增工具页无需改动核心主页面主体流程。
3. **标准化**：统一包管理、代码规范、提交与 CI 门禁。
4. **最佳实践**：类型安全、错误可观测、配置可迁移。
5. **性能优化**：降低采样链路 CPU/IO 开销，缩小前端资源体积。
6. **功能优化与结构优化**：提升导入导出可靠性、补齐延迟监控、清理仓库结构噪音。

---

## 3) 分阶段执行计划（P0/P1/P2）

- **P0（1~2 周）**：先解决“高风险 + 高收益”项（结构拆分、性能热点、安全边界、工程门禁）。
- **P1（2~4 周）**：统一持久化/配置模型、完善导入导出与跨窗同步。
- **P2（持续演进）**：可观测性、目录治理、细节性能打磨。

---

## 4) 优化项明细（每项含内容与具体步骤）

## P0-01 巨型页面拆分（维护性/结构）
- 类别：维护性、结构优化
- 现状：`src/pages/index.vue` 职责过多（UI、主题裁剪、导入导出、热键、窗口管理、配置应用）。
- 优化内容：按“功能域”拆成 composable + 子组件，页面只保留编排。
- 具体步骤：
  1. 新建 `useThemeManager.ts`：主题 CRUD、裁剪、存储。
  2. 新建 `useConfigTransfer.ts`：导入/导出、校验、回滚。
  3. 新建 `useFactoryReset.ts`：重置确认与执行。
  4. 新建 `useToolkitLauncher.ts`：工具窗创建/唤醒。
  5. `index.vue` 仅保留状态聚合和事件绑定。
- 验收：`index.vue` < 500 行；任一功能模块可独立单测。

## P0-02 Store 分层与职责收敛（维护性/扩展性）
- 类别：维护性、扩展性
- 现状：`src/stores/app.ts` 同时承载设置、窗口、托盘、任务栏、启动项、卸载等多职责。
- 优化内容：拆分为多 Store：`settingsStore`、`windowStore`、`systemStore`、`telemetryStore`。
- 具体步骤：
  1. 抽离设置读写与广播。
  2. 抽离窗口与托盘管理。
  3. 抽离安装态/启动项/卸载能力。
  4. 保留 `appStore` 仅作聚合 facade。
- 验收：单 Store 功能边界清晰；文件长度显著下降。

## P0-03 类型安全改造（最佳实践/标准化）
- 类别：最佳实践、标准化
- 现状：存在 `any` 与宽松反序列化（如 `src/pages/index.vue:470`、`:1419`、`:1348`）。
- 优化内容：引入 schema 校验与类型守卫，移除关键路径 `any`。
- 具体步骤：
  1. 为导入配置定义 `ConfigSchema`（建议 zod 或手写 type guard）。
  2. `sanitizeThemes / applyImportedOverlayPrefs / isPositionLike` 改为强类型入参。
  3. 严禁 `as any` 穿透到业务层。
  4. 在 CI 加 `vue-tsc --noEmit` + `noImplicitAny` 守卫。
- 验收：导入路径 `any=0`；无未校验 JSON 直接落地。

## P0-04 错误处理与日志可观测（最佳实践）
- 类别：最佳实践、维护性
- 现状：存在大量 `catch {}`，错误上下文丢失，排障困难。
- 优化内容：统一错误处理策略（用户提示 + 结构化日志）。
- 具体步骤：
  1. 新建 `src/utils/error.ts`（`reportError(scope, err, extra)`）。
  2. 约定“可忽略错误白名单”，其余必须记录。
  3. 前端关键链路加入 toast/弹窗反馈（导入、导出、窗口创建、启动项设置）。
  4. Rust 侧补充 `tracing::error/warn` 上下文字段。
- 验收：关键流程错误可追溯；用户可理解失败原因。

## P0-05 资源体积优化：字体与图标（性能）
- 类别：性能优化
- 现状：`dist` 中 Material Symbols 多个大文件占体积主导。
- 优化内容：缩减字体子集或切换 SVG 图标方案。
- 具体步骤：
  1. 统计实际使用图标集合（CPU/GPU/内存/网络/按钮等）。
  2. 将 `@fontsource/material-symbols-outlined` 改为受控子集（或 SVG sprite）。
  3. Inter/JetBrains Mono 权重按实际 UI 使用裁剪。
  4. 对比构建前后产物体积并记录报告。
- 验收：`dist` 总体积下降 25%+；首屏资源数量明显减少。

## P0-06 GPU 采样链路重构（性能/稳定性）
- 类别：性能优化、结构优化
- 现状：每 2 秒通过 PowerShell 子进程采样 GPU（`system_collector.rs:368/493`），开销较高。
- 优化内容：改为长期驻留采样器或纯 Rust/Windows API 路径，避免频繁拉起进程。
- 具体步骤：
  1. 封装 `GpuSampler`（初始化一次，循环采样）。
  2. 优先使用 PDH/DXGI；PowerShell 仅作降级兜底。
  3. 引入采样超时与熔断（连续失败后退避）。
  4. 增加采样开销日志（平均耗时、失败率）。
- 验收：空闲 CPU 占用降低；GPU 指标更新更平稳。

## P0-07 定时关机安全边界优化（功能/风险控制）
- 类别：功能优化、最佳实践
- 现状：`clear_existing_shutdown_schedule()` 执行全局 `shutdown /a`，可能误取消用户其他来源关机。
- 优化内容：只清理本应用创建的计划，不影响系统其他任务。
- 具体步骤：
  1. 对倒计时模式增加“应用签名标记”与独立状态跟踪。
  2. 对 `schtasks` 仅删除 `PulseCoreLite_Shutdown`。
  3. 取消全局 `shutdown /a`，改为在本应用创建的倒计时句柄上操作。
  4. 增加用户确认文案，明确影响范围。
- 验收：不会误操作系统级其他关机计划。

## P0-08 建立测试与 CI 门禁（标准化/维护性）
- 类别：标准化、维护性
- 现状：无测试与 CI 自动校验。
- 优化内容：最小可用测试金字塔 + 持续集成。
- 具体步骤：
  1. 前端：Vitest + Vue Testing Library（prefs、导入导出、热键解析）。
  2. Rust：关键命令单元测试（时间解析、计划构建、输入校验）。
  3. 新建 CI：`npm ci`、`npm run build`、`cargo check`、测试执行。
  4. PR 必须通过门禁方可合并。
- 验收：主分支改动可自动回归验证。

## P1-09 工程规范统一（标准化）
- 类别：标准化、最佳实践
- 现状：缺少 ESLint/Prettier/提交规范。
- 优化内容：规范代码风格与提交质量。
- 具体步骤：
  1. 引入 ESLint（Vue + TS）与 Prettier。
  2. 配置 `lint-staged + husky`，提交前自动校验。
  3. 增加 `npm run lint`、`npm run format:check`。
  4. 补充 CONTRIBUTING 规范。
- 验收：代码风格一致；低级问题前置拦截。

## P1-10 包管理与版本一致性（标准化）
- 类别：标准化、结构优化
- 现状：同时存在 `package-lock.json` 与 `pnpm-lock.yaml`；Rust `Cargo.toml` 版本与前端版本不一致。
- 优化内容：统一版本源与包管理策略。
- 具体步骤：
  1. 决策单一包管理器（npm 或 pnpm）。
  2. 清理另一套 lockfile，文档同步。
  3. 新增 `sync-version` 脚本：同步 `package.json`、`tauri.conf.json`、`Cargo.toml`。
  4. 发布前校验版本一致性。
- 验收：版本号单源可追溯；构建环境可复现。

## P1-11 持久化统一与迁移机制（扩展性/维护性）
- 类别：扩展性、维护性
- 现状：`localStorage` 与 KV 混用，键散落（如 refresh_rate、taskbar_prefs、overlay_pos）。
- 优化内容：构建统一配置仓储层（带 schemaVersion 迁移）。
- 具体步骤：
  1. 新建 `configRepository`（读/写/迁移/回滚）。
  2. 收口 key 常量到单文件。
  3. 首次启动执行迁移脚本，迁移后仅保留统一存储。
  4. 加入迁移日志与失败回退。
- 验收：配置来源单一；历史版本平滑升级。

## P1-12 导入导出事务化（功能/可靠性）
- 类别：功能优化、最佳实践
- 现状：导入过程中多点写入，异常时可能“部分成功”。
- 优化内容：引入事务化应用流程。
- 具体步骤：
  1. 先在内存构造 `nextState`，全部校验通过后一次性提交。
  2. 导入前自动创建快照备份。
  3. 任一步失败自动回滚并提示。
  4. 导入结果输出明细（成功项/跳过项/失败项）。
- 验收：导入要么全成功要么全回滚。

## P1-13 网络延迟功能补齐（功能优化）
- 类别：功能优化
- 现状：UI 支持延迟显示，但采样默认 `latency_ms: None`（`system_collector.rs:349`）。
- 优化内容：实现可配置延迟探测（低频）。
- 具体步骤：
  1. 后端增加异步 ping 任务（可配置目标与周期）。
  2. 采样结果写入 `network.latency_ms`。
  3. 前端补充异常态与禁用态展示。
  4. 增加隐私/网络说明（仅对指定目标做探测）。
- 验收：延迟指标可稳定展示，失败时有可理解状态。

## P1-14 多窗口同步机制升级（扩展性/稳定性）
- 类别：扩展性、稳定性
- 现状：当前跨窗同步依赖事件 + 本地存储重读，时序复杂。
- 优化内容：建立统一“主窗口为源”的同步协议。
- 具体步骤：
  1. 主窗作为配置主写入端，其他窗通过命令请求更新。
  2. 增加配置版本号（递增），按版本拉取。
  3. 失败重试与冲突策略（最后写入 + 时间戳）。
  4. 关闭/重开窗口时自动全量同步。
- 验收：多窗口设置变更一致，无错乱回跳。

## P2-15 目录治理与仓库瘦身（结构优化）
- 类别：结构优化、维护性
- 现状：仓库含 `.bak` 文件、设计原稿与代码混放。
- 优化内容：清理无效文件，分离“运行代码”与“设计资产”。
- 具体步骤：
  1. 删除或迁移 `*.bak.*` 至 `archive/`。
  2. 将大体积设计素材迁移到 `docs/design/` 或外部设计仓。
  3. 在 README 添加结构说明与边界。
  4. 增加仓库体积巡检脚本。
- 验收：主仓结构清晰、检索效率提升。

## P2-16 前端渲染微优化（性能）
- 类别：性能优化
- 现状：高频状态下计算链较长（overlay/taskbar 都在消费快照）。
- 优化内容：减少无效重算与重绘。
- 具体步骤：
  1. 将高频指标和低频信息拆分响应式源。
  2. 对不变文本/样式使用 memo 化与常量缓存。
  3. 关键组件加 `requestAnimationFrame` 节流渲染策略。
  4. 性能面板对比优化前后帧稳定性。
- 验收：高频刷新下 UI 更平滑，CPU 占用下降。

## P2-17 后端采样分层（性能/扩展性）
- 类别：性能优化、扩展性
- 现状：采样存在“统一节奏”倾向，重指标与轻指标未充分分层。
- 优化内容：按成本分级采样并缓存。
- 具体步骤：
  1. 1s：CPU/内存/网络速率；2~5s：GPU/磁盘/硬件信息。
  2. 各采样器维护独立 TTL 缓存。
  3. 前端按“最后更新时间”展示数据新鲜度。
  4. 增加采样预算（单周期最大耗时阈值）。
- 验收：采样抖动减小，整体资源占用更稳定。

## P2-18 可观测性与发布质量报告（最佳实践）
- 类别：最佳实践、标准化
- 现状：缺少固定的版本性能/质量对比产物。
- 优化内容：建立每次发布的“质量报告模板”。
- 具体步骤：
  1. 固定输出：包体积、启动耗时、空闲 CPU、内存占用。
  2. 发布前自动生成 `release-quality-report.md`。
  3. 将关键指标写入版本说明。
  4. 建立回归阈值（超阈值阻止发布）。
- 验收：每版可量化比较，质量趋势可追踪。

---

## 5) 推荐执行顺序（建议）

1. 先做 P0-05 + P0-06（最快看到性能收益）。
2. 并行做 P0-01 + P0-02（降低后续改造成本）。
3. 再做 P0-08（把“质量门”立起来）。
4. 进入 P1，统一配置与导入导出可靠性。
5. 最后做 P2 的持续优化与治理。

---

## 6) 里程碑验收指标（建议目标值）

- 包体积：`dist` 总体积降低 25%+。
- 结构：`index.vue`、`app.ts` 均降至 500 行以内。
- 类型安全：关键导入路径 `any = 0`。
- 质量门：CI 覆盖 build + typecheck + unit test。
- 稳定性：导入导出支持回滚，跨窗设置一致性可复现通过。
- 性能：空闲 CPU 与采样抖动明显下降（以发布报告为准）。

---

## 7) 本文档对应的关键代码定位（便于实施）

- `src/pages/index.vue`
- `src/stores/app.ts`
- `src/composables/useOverlayPrefs.ts`
- `src/composables/useTaskbarPrefs.ts`
- `src/composables/useOverlayRefreshRate.ts`
- `src-tauri/src/core/collectors/system_collector.rs`
- `src-tauri/src/ipc/commands.rs`
- `package.json`
- `src-tauri/Cargo.toml`
- `src-tauri/tauri.conf.json`
